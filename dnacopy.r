setwd("C:/Users/zjy52/Desktop/重测序/CNV")
library(dplyr)
library(data.table)
library(ggplot2)
library(DNAcopy)
bfile=list.files('data/bed/',pattern = '_dup_sorted.bed')
for( j in 1:length(bfile)){
bed=fread(paste0('data/bed/',bfile[j]))
name=strsplit(bfile[j],'_dup_sorted.bed')[[1]][1]
bname=gsub('-1','',name)
data=fread(paste0('data/csv/',name,'_dup.csv.sample_interval_summary'))
le=fread('length.txt')
le=le[order(-le$length),]
top=le[1:8,]$id
bd=bed[grep(top[1],bed$V1),]
bb=data[grep(top[1],data$Target),]
for( i in 2:length(top)){
temp=bed[grep(top[i],bed$V1),]
t2=data[grep(top[i],data$Target),]
bd=rbind(bd,temp)
bb=rbind(bb,t2)
}
for(i in 1:nrow(bb)){
  bb$Target[i]=strsplit(bb$Target[i],':')[[1]][1]
}
bb=bb[,c(1,3)]
#bb=bb %>% group_by(Target) %>% summarise(mean=mean(average_coverage)) %>% ungroup()
ave=mean(bb$average_coverage)
bd$ave=ave
#bd=left_join(bd,bb,by=c('V1'='Target'))
bd$ID=''
for(i in 1:nrow(bd)){
  bd$ID[i]=paste0(bd$V1[i],'_','(',bd$V2[i],'-',bd$V3[i],')')
}
bd=bd[,c(10,1,2,3,5,9,8)]
colnames(bd)=c('ID','Scaffold','star','end','bp','average_coverage','window_coverage')
bd$window_coverage=bd$window_coverage*100
dd=bd
bd$`log2Value`=log2((bd$window_coverage)/(bd$average_coverage))
bd[bd$window_coverage==0,]$`log2Value`=0
bd=bd[,c(1:4,8)]
bd$Position=seq(1,nrow(bd))
scc=unique(bd$Scaffold)
color=rep(c('#C0FF3E','#3D3D3D'),4)
bp=bd[bd$log2Value!=0,]
mi=min(bp$log2Value)
ma=max(bp$log2Value)
mi=round(mi)-0.2
ma=round(ma)+0.2
p=ggplot(bp)+geom_point(aes(x=ID,y=`log2Value`,color=Scaffold))+
  scale_color_manual(values = color)+
  theme(axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        legend.position = )+
  xlab('Postion(Scaffold,base)')+
  ylab('log2(Window coverage/Average genome coverage')+
  geom_hline(yintercept = 0,size=1,color='red')+
  scale_y_continuous(limits =c(-2,2))
  
p




pdf(paste0('plot/ca_pdf/',name,'.pdf'),width = 15,height = 9)
print(p)
dev.off()

png(paste0('plot/ca_png/',name,'.png'),width = 600,height = 450)
print(p)
dev.off()
dd=dd[,c(1:2,6:7)]
write.csv(dd,paste0('statistic/',bname,'_Coverageratios.csv'),row.names = F,quote = F)
}

























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































